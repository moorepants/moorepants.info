title: Notebook Entry
:subtitle: April 23, 2014
:description:
:date: 2014-04-23 17:59:43
tags:
    - notebook
    - gait
    - system identification
    - control



This is potentially a very simple way to think about what we measure and
estimate from force plate and motion capture data during gait and how it
connects to the active forces we generate from our muscles for control. To
avoid non-linearities and keep things simple here is a three particle model:



.. image:: https://objects-us-east-1.dream.io/moorepants/simplified-gait-model.png

- :math:`m_t`: the treadmill mass
- :math:`m_f`: the foot mass
- :math:`m_s`: the shank mass
- :math:`F_p`: the force applied to perturb the displacement of the treadmill,
  and thus the whole system
- :math:`F_c`: the contact force between the foot at the treadmill. There are
  models that can represent contact, but for now I'll just assume that it is
  some kind of force producer. [#]_
- :math:`F_0`, :math:`F_a`: Both of these are active forces applied between the
  foot and the shank. This is synonymous to the forces generated by actively
  controlling the muscles that connect the two bodies and can be generalized to
  joint torques for a typical walking model. The reason for having two will be
  explained below.
- :math:`k`, :math:`c`: Coefficients for simple linear stiffness and damping
  force generators that represent the passive portions force generators between
  the foot and the shank.
- :math:`y_t,y_f,y_s`: The distances of each mass above the ground.
- :math:`\Delta y`: The distance between the foot and shank, synonymous with a
  joint angle.

The equations of motion of this system look like this:

.. math::

  -gm_t - m_t\dot{v}_t - F_c + F_p = 0

  -c\Delta y - gm_f - k\Delta y - m_f\dot{v}_f - F_a - F_0 + F_c = 0

  c\Delta y - gm_s + k\Delta y - m_s\dot{v}_s + F_a + F_0 = 0

Since I define :math:`F_c` as a generic force, the top equation is not coupled
to the bottom two. Now thinking about the second equation, I can measure, or
estimate reasonably well, these quantities: :math:`\Delta y, g, m_f, \dot{v}_f,
F_c`. So inverse dynamics says we can solve for :math:`F` given our
measurements:

.. math::

  F = F_c - m_f(g + \dot{v}_f)

:math:`F` is synonymous with the joint torques that we estimate from inverse
dynamics in a typical gait analysis. But :math:`F` is also the sum of both the
passive and active forces in the joint.

.. math::

  F = c\Delta v + k\Delta y + F_a + F_0

So if we can estimate :math:`F` with inverse dynamics then all I need are
reasonable estimates of the passive portion of the joint forces, i.e.
:math:`c` and :math:`k` in this case to compute the active forces.

Now if there is a real system that can be reasonably modeled by the above I
could excite it, cause some motion, take the measurements, and compute an
estimate of the total force acting between the foot and shank, i.e. :math:`F`.

At this point I can define what the active forces, :math:`F_a,F_0` are. Gait
is periodic, so if :math:`F_p=0`, :math`F_a=0`, and :math:`F_0=sin(t)` are used
to excite the real system, there will be some steady state periodic motion of
the system. We call the steady state of :math:`\Delta y` and :math:`\Delta v`
:math:`y_0` and :math:`v_0`, respectively. These two are synonymous with the
"open loop" joint angles and rates that can drive a gait model for walking.
This steady state can be thought of as the desired system state, i.e. the state
trajectories we want to track while the system is being perturbed.

So now if I perturb this oscillating real system with :math:`F_p\neq0`, white
noise for example, then then :math:`\Delta y` and :math:`\Delta v` will no
longer equal :math:`y_0` and :math:`v_0`. We can then think of :math:`F_a` as a
force that applies some feedback to drive :math:`\Delta y,\Delta v` to
:math:`y_0,v_0`. This can be written as so:

.. math::

  F_a = c_a[v_0 - \Delta v] + k_a[y_0 - \Delta y]

The equation for the joint forces then become:

.. math::

  F = c\Delta v + k\Delta y + c_a[v_0 - \Delta v] + k_a[y_0 - \Delta y] + F_0

  F = [c - c_a]\Delta v + [k - k_a]\Delta y + c_a v_0 + k_a y_0 + F_0

I can measure or estimate only :math:`F`, :math:`\Delta v`, and :math:`\Delta
y`. The ideal goal is to figure out what :math:`c_a` and :math:`k_a` are, i.e.
the active gains in the controller. If :math:`F_0` and :math:`v_0` are periodic
and I have enough measurements in time, i.e. from multiple periods, then I
can get estimates of :math:`c_t=c-c_a` and :math:`k_t=k-k_a`. These are the
combined passive and active stiffness and damping coefficients. This
formulation will also allow the estimation of this periodic term:

.. math::

  F^* = c_a v_0 + k_a y_0 + F_0

This shows that the best I can do is to estimate "gains" which are combinations
of the stiffness and damping from passive and active forces.

But if I collect data when :math:`F_p=0` we can possibly get estimates of
:math:`v_0` and :math:`y_0` which could allow me to estimate both the active
and passive gains, independently.

Other researchers in biomechanics talk about "impedance" and "joint impedance".
For example in [Rouse2012]_ defines impedance in the ankle joint as:

.. math::

  T_i = I_i \ddot{\theta} + c_i \dot{\theta} + k_i \theta

:math:`T_i` is the "joint torque" but he doesn't use standard inverse dynamics,
he neglects the foot mass, so his joint torque estimate is basically the
measured ground reaction moment. It follows this form:

.. math::

  T = T_c = I \ddot{\theta} + c \dot{\theta} + k \theta + gm_fl\theta + T_a + T_0

Now if :math:`T_a` is a PD controller, as described above, you get:

.. math::

  T_a = c_a [\dot{\theta}_0 - \dot{\theta}] + k_a [\theta_0 - \theta]

and then:

.. math::

  T_i = I \ddot{\theta} + c \dot{\theta} + k \theta + gm_fl\theta +
  c_a [\dot{\theta}_0 - \dot{\theta}] + k_a [\theta_0 - \theta] + T_0

  T_i = I \ddot{\theta} + (c - c_a) \dot{\theta} + (k - k_a + gm_fl) \theta
  c_a \dot{\theta}_0 + k_a \theta_0 + T_0

In his experiments, he collects data during the stance phase for one foot over
and over again (something like 400 steps per subject) with one of four
perturbations applied during each step. He measures or estimates the "joint
torque" [#]_, :math:`T_i`, and the ankle angle, :math:`\theta`
(:math:`\ddot{\theta}` and :math:`\dot{\theta}` are computed by numerical
differentiation). A simple linear least squares is then used to estimate
:math:`I_i,c_i`, and :math:`k_i`. He assumes that these parameters are time
invariant (at least for the stance phase).

If we compare his "impedance" model to my formulation we see:

.. math::

  I_i = I

  c_i = c - c_a

  k_i = k - k_a + gm_fl

  0 = c_a \dot{\theta}_0 + k_a \theta_0 + T_0 = T^*

So his estimated parameters are not only a lumping of active and passive torque
coefficients, but also gravitational terms. And he completely neglects the
terms I call :math:`F^*` above (here we can use :math:`T^*` for the last
equations). But he is able to find impedance parameters such that his model
fits the data he collected, even when neglecting this constant term. It likely
gets lumped into the output error of the linear least squares fit and may be
small.

.. [Rouse2012] Rouse et al., “Estimation of Human Ankle Impedance during
   Walking Using the Perturberator Robot.”

.. [#] Note that this ignores the fact that forces plates measure the forces
   between two masses. Inertial effects has to be accounted for when moving the
   force plate, but the following analysis assumes we can measure the force at
   the surface (not at the load cells).

.. [#] This is not the traditional joint torque because it includes inertial
   and gravitational effects in addition to passive and active joint torques.
